name: Sync Images to Aliyun
# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ (ç‚¹å‡» Run workflow æŒ‰é’®)
on: 
  workflow_dispatch:
    inputs:
      # è¿™é‡Œå…è®¸ä½ æ‰‹åŠ¨è¾“å…¥é•œåƒåï¼Œå¦‚æœä¸è¾“åˆ™ç”¨é»˜è®¤çš„
      image_name:
        description: 'Image name to sync (e.g., redis:latest)'
        required: false
        default: 'all' 

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Install Skopeo
        # GitHub çš„ ubuntu ç¯å¢ƒé‡Œé€šå¸¸è‡ªå¸¦ skopeoï¼Œé˜²æ­¢ä¸‡ä¸€æˆ‘ä»¬å¯ä»¥è£…ä¸€ä¸‹
        run: |
          sudo apt-get update
          sudo apt-get -y install skopeo

      - name: Login to Aliyun ACR
        # ä½¿ç”¨æˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥é…ç½®çš„ Secrets ç™»å½•
        run: |
          skopeo login -u "${{ secrets.ALIYUN_USERNAME }}" \
                       -p "${{ secrets.ALIYUN_PASSWORD }}" \
                       ${{ secrets.ALIYUN_REGISTRY }}

      - name: Sync Images
        run: |
          # æ ¼å¼ï¼šåŸé•œåƒåœ°å€ ç›®æ ‡é•œåƒåœ°å€
          # å·¦ä¾§ï¼šæºåœ°å€
          # å³ä¾§ï¼šç›®æ ‡åœ°å€ï¼ˆä¸å« Registry åŸŸåï¼Œä½†åŒ…å« å‘½åç©ºé—´/ä»“åº“å:æ ‡ç­¾ï¼‰
          declare -A images
          images=(
            ["docker.io/library/redis:latest"]="songxuan/redis:latest"
            ["docker.io/library/mysql:8.0"]="songxuan/mysql:8.0"
            ["docker.io/onlyoffice/documentserver:9.2"]="songxuan/onlyoffice/documentserver:9.2"
          )

          INPUT_IMAGE="${{ github.event.inputs.image_name }}"
          
          # === å¤„ç†æ‰‹åŠ¨è§¦å‘é€»è¾‘ ===
          if [ "$INPUT_IMAGE" != "all" ] && [ -n "$INPUT_IMAGE" ]; then
             echo "ğŸš€ å•ç‹¬åŒæ­¥: $INPUT_IMAGE"
             
             # å»é™¤ docker.io/ å‰ç¼€ (å¦‚æœæœ‰)
             CLEAN_IMAGE="${INPUT_IMAGE#docker.io/}"
             
             # å¤„ç† library é•œåƒ (ä¾‹å¦‚è¾“å…¥ redis:alpineï¼Œå˜æˆ library/redis:alpineï¼Œé¿å…å˜æˆ songxuan/redis:alpine å¯¼è‡´è¦†ç›–å†²çª? 
             # æˆ–è€…ä½ æƒ³ä¿æŒ songxuan/redis:alpine ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œä¸»è¦é’ˆå¯¹ onlyoffice è¿™ç§é library é•œåƒ)
             # è¿™é‡Œç›´æ¥ä½¿ç”¨ CLEAN_IMAGEï¼Œæ•ˆæœå°±æ˜¯ songxuan/onlyoffice/documentserver:9.2
             
             DEST_IMAGE="${{ secrets.ALIYUN_REGISTRY }}/songxuan/${CLEAN_IMAGE}"
             
             echo "ç›®æ ‡åœ°å€: $DEST_IMAGE"
             skopeo copy --all docker://$INPUT_IMAGE docker://$DEST_IMAGE
             exit 0
          fi

          # === å¤„ç†åˆ—è¡¨å¾ªç¯é€»è¾‘ ===
          for src in "${!images[@]}"; do
            dest="${images[$src]}"
            echo "----------------------------------------------------"
            echo "ğŸš€ å¼€å§‹åŒæ­¥: $src -> ${{ secrets.ALIYUN_REGISTRY }}/$dest"
            
            skopeo copy --all \
              docker://$src \
              docker://${{ secrets.ALIYUN_REGISTRY }}/$dest
              
            echo "âœ… åŒæ­¥å®Œæˆ"
          done
