name: Sync Images to Aliyun
on: 
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Image name to sync (e.g., redis:latest)'
        required: false
        default: 'all' 

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get -y install skopeo

      - name: Login to Aliyun ACR
        run: |
          skopeo login -u "${{ secrets.ALIYUN_USERNAME }}" \
                       -p "${{ secrets.ALIYUN_PASSWORD }}" \
                       ${{ secrets.ALIYUN_REGISTRY }}

      - name: Sync Images
        run: |
          # æ ¼å¼ï¼š["æºåœ°å€"]="ç›®æ ‡ä»“åº“å"
          # æ³¨æ„ï¼šè¿™é‡Œç›®æ ‡ä»“åº“åä¸å†å¸¦æ–œæ ï¼Œç”±è„šæœ¬è‡ªåŠ¨å¤„ç†
          declare -A images
          images=(
            ["docker.io/library/redis:latest"]="redis:latest"
            ["docker.io/library/mysql:8.0"]="mysql:8.0"
            ["docker.io/onlyoffice/documentserver:9.2"]="onlyoffice-documentserver:9.2"
          )

          INPUT_IMAGE="${{ github.event.inputs.image_name }}"
          MY_NAMESPACE="songxuan" # ä½ çš„é˜¿é‡Œäº‘å‘½åç©ºé—´
          
          # === å¤„ç†æ‰‹åŠ¨è§¦å‘é€»è¾‘ ===
          if [ "$INPUT_IMAGE" != "all" ] && [ -n "$INPUT_IMAGE" ]; then
             echo "ğŸš€ å•ç‹¬åŒæ­¥: $INPUT_IMAGE"
             
             # 1. å»é™¤åŸŸåå’Œ library/ å‰ç¼€ (å¦‚æœæœ‰)
             TMP_NAME="${INPUT_IMAGE#docker.io/}"
             TMP_NAME="${TMP_NAME#library/}"
             
             # 2. æå– Tag
             TAG="${TMP_NAME##*:}"
             NAME_NO_TAG="${TMP_NAME%:*}"
             if [ "$TAG" == "$NAME_NO_TAG" ]; then TAG="latest"; fi

             # 3. å°†é•œåƒåä¸­çš„ / æ›¿æ¢ä¸º - (ä¾‹å¦‚ onlyoffice/documentserver -> onlyoffice-documentserver)
             CLEAN_NAME=$(echo "$NAME_NO_TAG" | sed 's/\//-/g')
             
             DEST_IMAGE="${{ secrets.ALIYUN_REGISTRY }}/$MY_NAMESPACE/${CLEAN_NAME}:${TAG}"
             
             echo "ç›®æ ‡åœ°å€: $DEST_IMAGE"
             # ä½¿ç”¨ --all åŒæ­¥æ‰€æœ‰æ¶æ„ï¼Œå¦‚æœæŠ¥é”™å¯ä»¥å»æ‰ --all åªåŒæ­¥å½“å‰æ¶æ„
             skopeo copy --all docker://$INPUT_IMAGE docker://$DEST_IMAGE
             exit 0
          fi

          # === å¤„ç†åˆ—è¡¨å¾ªç¯é€»è¾‘ ===
          for src in "${!images[@]}"; do
            repo_with_tag="${images[$src]}"
            echo "----------------------------------------------------"
            echo "ğŸš€ å¼€å§‹åŒæ­¥: $src -> ${{ secrets.ALIYUN_REGISTRY }}/$MY_NAMESPACE/$repo_with_tag"
            
            skopeo copy --all \
              docker://$src \
              docker://${{ secrets.ALIYUN_REGISTRY }}/$MY_NAMESPACE/$repo_with_tag
              
            echo "âœ… åŒæ­¥å®Œæˆ"
          done
