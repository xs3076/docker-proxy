name: Sync Images to Aliyun
# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ (ç‚¹å‡» Run workflow æŒ‰é’®)
on: 
  workflow_dispatch:
    inputs:
      # è¿™é‡Œå…è®¸ä½ æ‰‹åŠ¨è¾“å…¥é•œåƒåï¼Œå¦‚æœä¸è¾“åˆ™ç”¨é»˜è®¤çš„
      image_name:
        description: 'Image name to sync (e.g., redis:latest)'
        required: false
        default: 'all' 

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Install Skopeo
        # GitHub çš„ ubuntu ç¯å¢ƒé‡Œé€šå¸¸è‡ªå¸¦ skopeoï¼Œé˜²æ­¢ä¸‡ä¸€æˆ‘ä»¬å¯ä»¥è£…ä¸€ä¸‹
        run: |
          sudo apt-get update
          sudo apt-get -y install skopeo

      - name: Login to Aliyun ACR
        # ä½¿ç”¨æˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥é…ç½®çš„ Secrets ç™»å½•
        run: |
          skopeo login -u "${{ secrets.ALIYUN_USERNAME }}" \
                       -p "${{ secrets.ALIYUN_PASSWORD }}" \
                       ${{ secrets.ALIYUN_REGISTRY }}

      - name: Sync Images
        run: |
          # å®šä¹‰ä½ è¦æ¬è¿çš„é•œåƒæ˜ å°„å…³ç³»
          # æ ¼å¼ï¼šåŸé•œåƒåœ°å€ ç›®æ ‡é•œåƒåœ°å€
          # æ³¨æ„ï¼šè¯·æŠŠä¸‹é¢çš„ songxuan æ¢æˆä½ è‡ªå·±åœ¨ä¸Šæµ·å®é™…åˆ›å»ºçš„å‘½åç©ºé—´ï¼
          
          declare -A images
          images=(
            ["docker.io/library/redis:latest"]="songxuan/redis:latest"
            ["docker.io/library/mysql:8.0"]="songxuan/mysql:8.0"
            ["docker.io/library/nginx:alpine"]="songxuan/nginx:alpine"
          )

          # å¦‚æœä½ åœ¨è¿è¡Œç•Œé¢è¾“å…¥äº†ç‰¹å®šé•œåƒï¼ŒåªåŒæ­¥é‚£ä¸€ä¸ª
          INPUT_IMAGE="${{ github.event.inputs.image_name }}"
          
          if [ "$INPUT_IMAGE" != "all" ] && [ -n "$INPUT_IMAGE" ]; then
             echo "ğŸš€ å•ç‹¬åŒæ­¥: $INPUT_IMAGE"
             skopeo copy --all docker://$INPUT_IMAGE docker://${{ secrets.ALIYUN_REGISTRY }}/songxuan/${INPUT_IMAGE##*/}
             exit 0
          fi

          # å¦åˆ™å¾ªç¯åŒæ­¥ä¸Šé¢åˆ—è¡¨é‡Œçš„æ‰€æœ‰é•œåƒ
          for src in "${!images[@]}"; do
            dest="${images[$src]}"
            echo "----------------------------------------------------"
            echo "ğŸš€ å¼€å§‹åŒæ­¥: $src -> ${{ secrets.ALIYUN_REGISTRY }}/$dest"
            
            skopeo copy --all \
              docker://$src \
              docker://${{ secrets.ALIYUN_REGISTRY }}/$dest
              
            echo "âœ… åŒæ­¥å®Œæˆ"
          done
